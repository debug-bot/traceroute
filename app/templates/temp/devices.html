{% extends 'temp/base.html' %} {% load static %} {% block styles %} {% endblock %} {% block content %}

<!-- Form (we'll handle submission via JavaScript) -->
<form id="commandForm" method="POST">
        <div class="d-flex gap-6 flex-column mt-6">
		{% csrf_token %}
		<!-- Top Row: Datacenter & Device -->
		<div class="card border-0 shadow-sm">
            <div class="card-body p-6">
                <div class="row g-6">
                    <div class="col-md-6">
                        <label for="datacenters-select" class="form-label">Datacenter(s)</label>
                        <!-- Multiple select using Select2 -->
                        <select
                            class="form-select w-100 d-none"
                            id="datacenters-select"
                            name="datacenters"
                            multiple
                        >
                            {% for item in unique_cities %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="devices-select" class="form-label">Device(s)</label>
                        <!-- Multiple select using Select2 -->
                        <select
                            class="form-select w-100 d-none"
                            id="devices-select"
                            name="devices"
                            multiple
                            disabled
                        >
                        </select>
                    </div>
                </div>
            </div>
		</div>

        <!-- 2nd Row: Command Execution -->
        <div class="card border-0 shadow-sm">
            <div class="card-header justify-content-between align-items-center p-6">
                    <h4 class="card-title mb-0">
                        <img
								class="h-lg-20px theme-light-show"
								src="{% static 'assets/media/svg/custom/command-execution.svg' %}"
								alt="Icon"
							/>
                            <img
								class="h-lg-20px theme-dark-show"
								src="{% static 'assets/media/svg/custom/command-execution-dark.svg' %}"
								alt="Icon"
							/>
                        <span class="ms-3 text-gray-900">Command Exeution</span></h4>
                    <a href="#" class="d-flex mt-2">
                        <img
								class="h-lg-16px m-0 theme-light-show"
								src="{% static 'assets/media/svg/custom/command-history-grey.svg' %}"
								alt="Icon"
							/>
                            <img
								class="h-lg-16px m-0 theme-dark-show"
								src="{% static 'assets/media/svg/custom/command-history-grey.svg' %}"
								alt="Icon"
							/>
                        <span class="ms-1 fs-5  text-gray-800">Command History</span>
                    </a>
            </div>
            <div class="card-body p-6">
                <!-- Command Category -->
                <div class="mt-2">
                    <h6 class="mb-3 text-gray-800">Select Command Category</h6>
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        <!-- category cards -->
                        {% for category in categories %}
                        <div class="col">
                            <div
                                class="card h-100 command-category shadow-none cursor-pointer"
                                data-category="{{ category.name }}"
                                data-category-id="{{ category.id }}"
                                
                            >
                                <div class="card-body p-4">
                                    <div class="d-flex gap-4 align-items-center">
                                    <img
                                        class="h-20px"
                                        src="{% static 'assets/media/svg/custom/network-grey.svg' %}"
                                        alt="Icon"
                                    />
                                    <div>
                                        <h5 class="text-gray-900">{{ category.name }}</h6>
                                        <p class="text-muted mb-0">
                                            {{ category.name }} commands
                                        </p>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Command Type (appears after selecting a category) -->
                <div class="mt-6" id="commandTypeSection" style="display: none">
                    <h6 class="mb-3 text-gray-800">Select Command Type</h6>
                    <div
                        class="row row-cols-1 row-cols-md-3 g-4"
                        id="commandTypeContainer"
                    >
                        <!-- Command type cards inserted by JavaScript -->
                    </div>
                </div>

                <!-- Execute Button -->
                <div class="d-flex justify-content-end mt-4">
                    <button
                        type="button"
                        class="btn btn-primary"
                        id="executeCommandBtn"
                    >
                        Execute Command
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %} {% block scripts %}
<script>
	$(document).ready(function () {
        // Do not show both select until select2 initializes
        $("#datacenters-select").removeClass("d-none");
        $("#devices-select").removeClass("d-none");

		// 1) Initialize Select2 for Datacenters and Devices
		$("#datacenters-select").select2({
			placeholder: "Select Datacenter(s)",
			allowClear: true,
		});
		$("#devices-select").select2({
			placeholder: "Select Device(s)",
			allowClear: true,
		});
        
        

		// 2) Mapping of category -> command types
		//    (Replace with real data from your app)
		// Build a JS object: categoryId -> list of commands
        const categoryCommands = {
            {% for category in categories %}
            "{{ category.id }}": [
                {% for command in category.command_set.all %}
                {
                    "id": "{{ command.id }}",
                    "label": "{{ command.label|escapejs }}",
                    "command": "{{ command.command|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

		let selectedCategory = null;
		let selectedCommandType = null;

		// 3) When user clicks a Category card
		$(".command-category").on("click", function () {
			// Highlight selected category
			$(".command-category").removeClass("border-primary");
			$(this).addClass("border-primary");
            // Also background color change to light blue
            $(".command-category").removeClass("bg-light");
            $(this).addClass("bg-light");

			selectedCategoryId = $(this).data("category-id");
			selectedCommandType = null; // reset command type

			// Show Command Type section
			$("#commandTypeSection").show();
			// Clear old command types
			$("#commandTypeContainer").empty();

			// Populate command types for this category
			if (categoryCommands[selectedCategoryId]) {
				categoryCommands[selectedCategoryId].forEach((ct) => {
					const cardHtml = `
                        <div class="col">
                            <div
                            class="card h-100 command-type shadow-none cursor-pointer"
                            data-command-type="${ct.command}"
                            >
                                <div class="card-body p-4">
                                    <h5 class="mb-0 text-gray-900">${ct.label}</h6>
                                </div>
                            </div>
                        </div>
                        `;
					$("#commandTypeContainer").append(cardHtml);
				});
			}
		});

		// 4) When user clicks a Command Type card
		$(document).on("click", ".command-type", function () {
			// Highlight selected command type
			$(".command-type").removeClass("border-primary");
			$(this).addClass("border-primary");
            // Also background color change to light blue
            $(".command-type").removeClass("bg-light");
            $(this).addClass("bg-light");

			selectedCommandType = $(this).data("command-type");
		});

		// 5) Handle "Execute Command" button
		$("#executeCommandBtn").on("click", function () {
			submitForm();
		});

		// Also submit on Enter (if all fields are chosen)
		$(document).on("keydown", function (e) {
			if (e.key === "Enter") {
				e.preventDefault(); // Prevent default form submission
				submitForm();
			}
		});

        $("#datacenters-select").on("change", function () {
            const selectedCities = $(this).val();
            const deviceSelect = $("#devices-select");

            if (!selectedCities || selectedCities.length === 0) {
                deviceSelect.empty();
                createTabs([]);
                return;
            }

            $.ajax({
                url: "/get-devices/",
                method: "GET",
                data: { cities: selectedCities },
                success: function (data) {
                    deviceSelect.empty();
                    if (data.devices.length > 0) {
                        data.devices.forEach((device) => {
                            deviceSelect.append(
                                `<option value="${device.id}">${device.name} (${device.ip})</option>`
                            );
                        });
                        $("#devices-select").prop("disabled", false);
                    } else {
                        deviceSelect.append(
                            `<option value="">No devices available</option>`
                        );
                    }
                },
                error: function () {
                    alert("Failed to fetch devices.");
                },
            });
        });

		function submitForm() {
			const datacentersSelected = $("#datacenters-select").val() || [];
			const devicesSelected = $("#devices-select").val() || [];

			// Basic validation
			if (!datacentersSelected.length) {
				alert("Please select at least one Datacenter.");
				return;
			}
			if (!devicesSelected.length) {
				alert("Please select at least one Device.");
				return;
			}
			if (!selectedCategory) {
				alert("Please select a Command Category.");
				return;
			}
			if (!selectedCommandType) {
				alert("Please select a Command Type.");
				return;
			}

			// Gather form data
			const csrfToken = $('[name="csrfmiddlewaretoken"]').val();
			const formData = {
				csrfmiddlewaretoken: csrfToken,
				datacenters: datacentersSelected,
				devices: devicesSelected,
				command_category: selectedCategory,
				command_type: selectedCommandType,
			};
            // Build the URL for the streaming view.
            const url =
                    "{% url 'network_tools_api' %}?router_id=" +
                    encodeURIComponent(device.id) +
                    "&command=" +
                    encodeURIComponent(selectedCommandType);

                // Submit form via xhr
                // Create a new XMLHttpRequest for streaming.
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);

                // Save this xhr in our activeXhrs array.
                activeXhrs.push(xhr);

                let processed = 0; // Keep track of processed characters

                xhr.onprogress = function () {
                    const responseText = xhr.responseText;
                    const newData = responseText.substring(processed);
                    processed = responseText.length;
                    newData.split("\n").forEach((line) => {
                        if (line.trim()) {
                            tabResponse.append(
                                `<div class="command">${line}</div>`
                            );
                        }
                    });
                };

                xhr.onload = function () {
                    if (xhr.status === 400) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            tabResponse.html(
                                `<div class="text-danger">Error: ${errorResponse.message}</div>`
                            );
                        } catch (error) {
                            tabResponse.html(
                                '<div class="text-danger">Error: Failed to execute command.</div>'
                            );
                        }
                    } else {
                        // Remove the "Running..." message when streaming is complete.
                        tabResponse.find("#runningStatus").remove();
                        console.log(
                            "Streaming complete for device: " + device.id
                        );
                    }
                    // Show the download button only after loading has finished
                    $(`#device-response-${device.id}`)
                        .children(".download-log")
                        .show();
                    // Remove this xhr from activeXhrs.
                    activeXhrs = activeXhrs.filter((item) => item !== xhr);
                    // If no more active requests remain, reset the button.
                    if (activeXhrs.length === 0) {
                        commandRunning = false;
                        $("#run-btn").text("Run");
                        $("#run-btn").prop("disabled", false);
                    }
                };

                xhr.onerror = function () {
                    tabResponse.html(
                        '<div class="text-danger">Failed to execute command.</div>'
                    );
                    // Also show the download button in error cases
                    $(`#device-response-${device.id}`)
                        .children(".download-log")
                        .show();
                    // Remove this xhr from activeXhrs.
                    activeXhrs = activeXhrs.filter((item) => item !== xhr);
                    if (activeXhrs.length === 0) {
                        commandRunning = false;
                        $("#run-btn").text("Run");
                    }
                };

                // Handle the abort event to display a message that the command was stopped.
                xhr.onabort = function () {
                    tabResponse.append(
                        '<div class="text-warning">Command aborted by user.</div>'
                    );
                    // Remove the "Running..." message when streaming is stopped.
                    tabResponse.find("#runningStatus").remove();
                    console.log("Streaming stopped for device: " + device.id);
                    // Show the download button when the request is aborted
                    $(`#device-response-${device.id}`)
                        .children(".download-log")
                        .show();
                    // Remove this xhr from activeXhrs.
                    activeXhrs = activeXhrs.filter((item) => item !== xhr);
                    if (activeXhrs.length === 0) {
                        commandRunning = false;
                        $("#run-btn").text("Run");
                    }
                };

                xhr.send();
            
		}
	});
</script>

{% endblock %}
