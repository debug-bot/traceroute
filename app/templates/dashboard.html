{% extends "base.html" %} {% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-3">
            <div class="card h-100 p-3 bg-light mode-container">
                <div class="mb-3">
                    <label for="cities-select" class="form-label"
                        >Select your Datacenter(s)</label
                    >
                    <select id="cities-select" class="form-select" multiple>
                        {% for item in unique_cities %}
                        <option value="{{ item }}">{{ item }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="device-select" class="form-label"
                        >Select your Device(s)</label
                    >
                    <select
                        id="device-select"
                        class="form-select"
                        multiple
                    ></select>
                </div>
                <div id="execute-command">
                    <div class="mb-3">
                        <label for="command-select" class="form-label"
                            >Select Command</label
                        >
                        <select id="command-select" class="form-select">
                            <option value="">Select a command</option>
                            {% for category in categories %}
                            <optgroup label="{{ category.name }}">
                                {% for command in category.command_set.all %}
                                <option value="{{ command.command }}">
                                    {{ command.label }}
                                </option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    <div
                        class="mb-3"
                        id="interface-selection"
                        style="display: none"
                    >
                        <label for="interface-sel" class="form-label"
                            >Interface Selection</label
                        >
                        <input
                            id="interface-sel"
                            class="form-control"
                            placeholder="Enter Target"
                        />
                    </div>
                </div>
                <div class="mb-3">
                    <input
                        type="checkbox"
                        id="custom-input-toggle"
                        class="form-check-input"
                    />
                    <label for="custom-input-toggle" class="form-check-label"
                        >Enter Custom Command</label
                    >
                </div>
                <div class="mb-3" id="custom-input-group" style="display: none">
                    <label for="custom-input" class="form-label"
                        >Custom Command</label
                    >
                    <input
                        id="custom-input"
                        class="form-control"
                        placeholder="Enter Custom Command"
                    />
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-sm btn-primary" id="run-btn">
                        Run
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card p-3 h-100 bg-light mode-container">
                <div id="devices-tabs" class="h-100">
                    <div
                        class="d-flex flex-column justify-content-center align-items-center h-100"
                    >
                        <p class="text-center">Select Devices to show tabs</p>
                    </div>
                </div>
                <div
                    id="download-device"
                    class="mt-3 d-flex w-100 justify-content-end d-none"
                >
                    <button class="btn btn-sm btn-success">Download</button>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .select2-results__group {
        cursor: pointer !important;
        padding-right: 20px;
        position: relative;
    }

    .select2-results__group:hover {
        background-color: #f0f0f0;
    }

    .select2-results__group:after {
        content: "ðŸž‚";
        position: absolute;
        right: 5%;
        top: 30%;
        font-size: 12px;
        pointer-events: none;
        transition: transform 0.2s ease;
    }

    .select2-results__group.collapsed:after {
        transform: rotate(90deg);
    }
</style>
<script>
    $(document).ready(function () {
        $("#command-select").select2({
            placeholder: "Select Command",
            width: "100%",
        });

        $("#command-select").change(function () {
            var selectedCommand = $(this).val();
            if (
                selectedCommand.includes(">") ||
                selectedCommand.includes("<")
            ) {
                $("#interface-selection").slideDown();
            } else {
                $("#interface-selection").slideUp();
            }
        });

        $("#command-select").on("select2:open", function () {
            setTimeout(function () {
                $(".select2-results__group").each(function () {
                    const $group = $(this);
                    $group.addClass("collapsed");
                    $group.nextUntil(".select2-results__group").hide();
                });

                $(".select2-results__group")
                    .off("click")
                    .on("click", function () {
                        const $group = $(this);
                        $group.toggleClass("collapsed");
                        $group
                            .nextUntil(".select2-results__group")
                            .slideToggle(200);
                    });
            }, 0);
        });
    });
    
    $(document).ready(function () {
        $("#cities-select").select2({
            placeholder: "Select datacenters",
            allowClear: true,
            width: "100%",
        });
        $("#device-select").select2({
            placeholder: "Select devices",
            allowClear: true,
            width: "100%",
        });
        $("#command-select").select2({
            placeholder: "Select Command",
            minimumResultsForSearch: -1,
            width: "100%",
        });

        function createDevicesTabsContainer() {
            const devicesTabsContainer = $("#devices-tabs");
            devicesTabsContainer.empty();
            const tabNav = $(
                '<ul class="nav nav-tabs" id="myTab" role="tablist"></ul>'
            );
            const tabContent = $(
                '<div class="tab-content h-100" id="myTabContent"></div>'
            );
            devicesTabsContainer.append(tabNav);
            devicesTabsContainer.append(tabContent);
        }

        function createTabs(devices) {
            if (devices.length === 0) {
                $("#devices-tabs").empty();
                $("#devices-tabs").append(`
                <div class="d-flex flex-column justify-content-center align-items-center h-100">
                    <p class="text-center">Select Devices to show tabs</p>
                </div>
                `);
                return;
            }
            createDevicesTabsContainer();
            const tabContainer = $("#myTab");
            const tabContent = $("#myTabContent");
            devices.forEach((device, index) => {
                const tabId = `device-tab-${index}`;
                const tabPaneId = `device-tab-content-${index}`;

                tabContainer.append(`
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link ${index === 0 ? "active" : ""}"
                            id="${tabId}"
                            data-bs-toggle="tab"
                            data-bs-target="#${tabPaneId}"
                            type="button"
                            role="tab"
                            aria-controls="${tabPaneId}"
                            aria-selected="${index === 0}"
                        >
                            ${device.name}
                        </button>
                    </li>
                `);

                tabContent.append(`
                    <div
                        class="tab-pane fade h-100 ${
                            index === 0 ? "show active" : ""
                        }"
                        id="${tabPaneId}"
                        role="tabpanel"
                        aria-labelledby="${tabId}"
                    >
                        <div id="device-response-${
                            device.id
                        }" class="card my-3 terminal">
                            <div>Click run button to show response</div>
                        </div>
                    </div>
                `);
            });
        }

        $("#cities-select").on("change", function () {
            const selectedCities = $(this).val();
            const deviceSelect = $("#device-select");

            if (!selectedCities || selectedCities.length === 0) {
                deviceSelect.empty();
                createTabs([]);
                return;
            }

            $.ajax({
                url: "/get-devices/",
                method: "GET",
                data: { cities: selectedCities },
                success: function (data) {
                    deviceSelect.empty();
                    if (data.devices.length > 0) {
                        data.devices.forEach((device) => {
                            deviceSelect.append(
                                `<option value="${device.id}">${device.name} (${device.ip})</option>`
                            );
                        });
                    } else {
                        deviceSelect.append(
                            `<option value="">No devices available</option>`
                        );
                    }
                },
                error: function () {
                    alert("Failed to fetch devices.");
                },
            });
        });

        $("#device-select").on("change", function () {
            const selectedDevices = $("#device-select")
                .find(":selected")
                .map(function () {
                    return {
                        name: $(this).text(),
                        id: $(this).val(),
                        ip: $(this).data("ip"),
                    };
                })
                .get();
            createTabs(selectedDevices);
        });

        $("#custom-input-toggle").on("change", function () {
            if ($(this).is(":checked")) {
                $("#custom-input-group").show();
                $("#execute-command").hide();
            } else {
                $("#custom-input-group").hide();
                $("#execute-command").show();
            }
        });

        $("#run-btn").on("click", function () {
            // Get the selected devices
            const selectedDevices = $("#device-select")
                .find(":selected")
                .map(function () {
                    return {
                        name: $(this).text(),
                        id: $(this).val(),
                        ip: $(this).data("ip"),
                    };
                })
                .get();

            if (!selectedDevices.length) {
                alert("Please select devices and a command before running.");
                return;
            }

            // Determine the command value
            let commandValue = "";
            const customInput = $("#custom-input-toggle").is(":checked");
            if (customInput) {
                commandValue = $("#custom-input").val();
            } else {
                const commandSelect = $("#command-select").val();
                if (
                    commandSelect.includes("<") ||
                    commandSelect.includes(">")
                ) {
                    const targetInput = $("#interface-sel").val();
                    if (!targetInput) {
                        alert("Please enter target.");
                        return;
                    }
                    commandValue = commandSelect.replace(
                        /<([^>]*)>/g,
                        targetInput
                    );
                } else {
                    commandValue = commandSelect;
                }
            }

            if (!commandValue) {
                alert("Please enter command.");
                return;
            }

            // For each selected device, stream the command response live.
            selectedDevices.forEach((device) => {
                const tabResponse = $(`#device-response-${device.id}`);
                // Show "Running..." with a loader
                tabResponse.html(
                    `
                        <div class="text-center" id="runningStatus">
                            <div class="loader-container">
                                Running... <span class="loader"></span>
                            </div>
                        </div>
                    `
                );

                // Build the URL for the streaming view.
                const url =
                    "{% url 'network_tools_api' %}?router_id=" +
                    encodeURIComponent(device.id) +
                    "&command=" +
                    encodeURIComponent(commandValue);

                // Create a new XMLHttpRequest for streaming
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                let processed = 0; // Number of characters already processed

                xhr.onprogress = function () {
                    const responseText = xhr.responseText;
                    const newData = responseText.substring(processed);
                    processed = responseText.length;
                    newData.split("\n").forEach((line) => {
                        if (line.trim()) {
                            tabResponse.append(
                                `<div class="command">${line}</div>`
                            );
                        }
                    });
                };

                // onload is called when the full response has been received
                xhr.onload = function () {
                    // Remove the "Running..." message and loader when streaming is complete
                    tabResponse.find("#runningStatus").remove();
                    console.log("Streaming complete for device: " + device.id);
                };

                xhr.onerror = function () {
                    tabResponse.html(
                        '<div class="text-danger">Failed to execute command.</div>'
                    );
                };

                xhr.send();
            });
        });
    });
</script>

{% endblock %}
